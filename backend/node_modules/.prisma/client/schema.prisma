// schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ===========================
// ENUMS (match MySQL ENUMs)
// ===========================

enum UserStatus {
  active
  inactive
}

enum InvoiceStatus {
  draft
  submitted
  delivered
  cancelled
}

enum PaymentType {
  cash
  credit
}

enum StockSourceType {
  invoice
  return
  manual
  warehouse_issue
  warehouse_receive
  restock
}

enum WarehouseSheetStatus {
  draft
  issued
  closed
}

enum RecoveryMethod {
  cash
  cheque
  bank
}

// ================
// CORE MASTER DATA
// ================

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users User[]

  @@map("roles")
}

model User {
  id           Int        @id @default(autoincrement())
  roleId       Int        @map("role_id")
  name         String
  email        String     @unique
  passwordHash String     @map("password_hash")
  phone        String?
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime?  @updatedAt @map("updated_at")

  role Role @relation(fields: [roleId], references: [id])

  // Relations
  products            Product[] @relation("ProductCreatedBy")
  invoicesCreated     Invoice[] @relation("InvoiceCreatedBy")
  invoicesOrderTaker  Invoice[] @relation("InvoiceOrderTaker")
  invoicesDeliveryMan Invoice[] @relation("InvoiceDeliveryMan")

  warehouseSheets    WarehouseLoadSheet[] @relation("WarehouseSheetCreatedBy")
  warehouseSheetsFor WarehouseLoadSheet[] @relation("WarehouseSheetDeliveryMan")

  stockLedgerEntries       StockLedger[]
  salesSummariesCreated    SalesSummary[]   @relation("SummaryCreatedBy")
  salesSummariesDelivery   SalesSummary[]   @relation("SummaryDeliveryMan")
  creditRecoveriesCreated  CreditRecovery[] @relation("CreditCreatedBy")
  creditRecoveriesDelivery CreditRecovery[] @relation("CreditDeliveryMan")
  wages                    Wage[]
  refreshTokens            RefreshToken[]

  @@map("users")
}

model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  address   String?
  phone     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  invoices   Invoice[]
  recoveries CreditRecovery[]

  @@map("customers")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  products Product[]

  @@map("categories")
}

model Product {
  id            Int       @id @default(autoincrement())
  categoryId    Int       @map("category_id")
  name          String
  sku           String    @unique
  sellingPrice  Decimal   @map("selling_price") @db.Decimal(12, 2)
  purchasePrice Decimal   @map("purchase_price") @db.Decimal(12, 2)
  lowStockLevel Int       @map("low_stock_level")
  cartonSize    Int?      @map("carton_size")
  createdById   Int       @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime? @updatedAt @map("updated_at")

  category  Category @relation(fields: [categoryId], references: [id])
  createdBy User     @relation("ProductCreatedBy", fields: [createdById], references: [id])

  stockLedger    StockLedger[]
  productStock   ProductStock?
  warehouseItems WarehouseLoadItem[]
  invoiceItems   InvoiceItem[]

  @@map("products")
}

// ==========
// INVENTORY
// ==========

model StockLedger {
  id          BigInt          @id @default(autoincrement())
  productId   Int             @map("product_id")
  qtyChange   Int             @map("qty_change")
  beforeQty   Int             @map("before_qty")
  afterQty    Int             @map("after_qty")
  sourceType  StockSourceType @map("source_type")
  sourceId    Int             @map("source_id")
  reason      String?
  createdById Int             @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")

  product   Product @relation(fields: [productId], references: [id])
  createdBy User    @relation(fields: [createdById], references: [id])

  @@map("stock_ledger")
}

model ProductStock {
  productId Int @id @map("product_id")
  quantity  Int

  product Product @relation(fields: [productId], references: [id])

  @@map("product_stock")
}

// =======================
// WAREHOUSE / LOAD SHEET
// =======================

model WarehouseLoadSheet {
  id            Int                  @id @default(autoincrement())
  sheetNo       String               @unique @map("sheet_no")
  deliveryManId Int                  @map("delivery_man_id")
  issueDate     DateTime             @map("issue_date") @db.Date
  status        WarehouseSheetStatus @default(draft)
  createdById   Int                  @map("created_by")
  createdAt     DateTime             @default(now()) @map("created_at")

  deliveryMan User @relation("WarehouseSheetDeliveryMan", fields: [deliveryManId], references: [id])
  createdBy   User @relation("WarehouseSheetCreatedBy", fields: [createdById], references: [id])

  items WarehouseLoadItem[]

  @@map("warehouse_load_sheets")
}

model WarehouseLoadItem {
  id        Int @id @default(autoincrement())
  sheetId   Int @map("sheet_id")
  productId Int @map("product_id")
  qtyIssued Int @map("qty_issued")

  sheet   WarehouseLoadSheet @relation(fields: [sheetId], references: [id])
  product Product            @relation(fields: [productId], references: [id])

  @@map("warehouse_load_items")
}

// =======
// SALES
// =======

model Invoice {
  id             Int           @id @default(autoincrement())
  invoiceNo      String        @unique @map("invoice_no")
  customerId     Int           @map("customer_id")
  invoiceDate    DateTime      @map("invoice_date") @db.Date
  deliveryManId  Int           @map("delivery_man_id")
  orderTakerId   Int           @map("order_taker_id")
  status         InvoiceStatus @default(submitted)
  paymentType    PaymentType   @map("payment_type")
  subtotalAmount Decimal       @map("subtotal_amount") @db.Decimal(14, 2)
  discountAmount Decimal       @map("discount_amount") @db.Decimal(14, 2)
  totalAmount    Decimal       @map("total_amount") @db.Decimal(14, 2)
  remarks        String?
  createdById    Int           @map("created_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime?     @updatedAt @map("updated_at")

  customer    Customer @relation(fields: [customerId], references: [id])
  deliveryMan User     @relation("InvoiceDeliveryMan", fields: [deliveryManId], references: [id])
  orderTaker  User     @relation("InvoiceOrderTaker", fields: [orderTakerId], references: [id])
  createdBy   User     @relation("InvoiceCreatedBy", fields: [createdById], references: [id])

  items        InvoiceItem[]
  summaryLinks SalesSummaryInvoice[]
  recoveries   CreditRecovery[]

  @@map("invoices")
}

model InvoiceItem {
  id        Int     @id @default(autoincrement())
  invoiceId Int     @map("invoice_id")
  productId Int     @map("product_id")
  quantity  Int
  price     Decimal @db.Decimal(12, 2)
  lineTotal Decimal @map("line_total") @db.Decimal(14, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

// ==============
// SALES SUMMARY
// ==============

model SalesSummary {
  id              Int      @id @default(autoincrement())
  deliveryManId   Int      @map("delivery_man_id")
  summaryDate     DateTime @map("summary_date") @db.Date
  bookedAmount    Decimal  @default(0) @map("booked_amount") @db.Decimal(14, 2)
  saleAmount      Decimal  @default(0) @map("sale_amount") @db.Decimal(14, 2)
  discountAmount  Decimal  @default(0) @map("discount_amount") @db.Decimal(14, 2)
  specialDiscount Decimal  @default(0) @map("special_discount") @db.Decimal(14, 2)
  gstAmount       Decimal  @default(0) @map("gst_amount") @db.Decimal(14, 2)
  roundAdjustment Decimal  @default(0) @map("round_adjustment") @db.Decimal(14, 2)
  summaryAmount   Decimal  @default(0) @map("summary_amount") @db.Decimal(14, 2)
  creditAmount    Decimal  @default(0) @map("credit_amount") @db.Decimal(14, 2)
  returnAmount    Decimal  @default(0) @map("return_amount") @db.Decimal(14, 2)
  chequeAmount    Decimal  @default(0) @map("cheque_amount") @db.Decimal(14, 2)
  transporterCost Decimal  @default(0) @map("transporter_cost") @db.Decimal(14, 2)
  recoveryAmount  Decimal  @default(0) @map("recovery_amount") @db.Decimal(14, 2)
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(14, 2)
  netSales        Decimal  @default(0) @map("net_sales") @db.Decimal(14, 2)

  note10   Int @default(0) @map("note_10")
  note20   Int @default(0) @map("note_20")
  note50   Int @default(0) @map("note_50")
  note100  Int @default(0) @map("note_100")
  note500  Int @default(0) @map("note_500")
  note1000 Int @default(0) @map("note_1000")
  note5000 Int @default(0) @map("note_5000")

  createdById Int       @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")

  deliveryMan User @relation("SummaryDeliveryMan", fields: [deliveryManId], references: [id])
  createdBy   User @relation("SummaryCreatedBy", fields: [createdById], references: [id])

  invoices   SalesSummaryInvoice[]
  recoveries CreditRecovery[]

  @@unique([deliveryManId, summaryDate], name: "uniq_dm_date")
  @@map("sales_summaries")
}

model SalesSummaryInvoice {
  id           Int         @id @default(autoincrement())
  summaryId    Int         @map("summary_id")
  invoiceId    Int         @map("invoice_id")
  paymentType  PaymentType @map("payment_type")
  cashAmount   Decimal     @default(0) @map("cash_amount") @db.Decimal(14, 2)
  creditAmount Decimal     @default(0) @map("credit_amount") @db.Decimal(14, 2)
  chequeAmount Decimal     @default(0) @map("cheque_amount") @db.Decimal(14, 2)
  returnAmount Decimal     @default(0) @map("return_amount") @db.Decimal(14, 2)

  summary SalesSummary @relation(fields: [summaryId], references: [id])
  invoice Invoice      @relation(fields: [invoiceId], references: [id])

  @@unique([summaryId, invoiceId], name: "uniq_summary_invoice")
  @@map("sales_summary_invoices")
}

// =================
// CREDIT RECOVERIES
// =================

model CreditRecovery {
  id            Int            @id @default(autoincrement())
  invoiceId     Int            @map("invoice_id")
  customerId    Int            @map("customer_id")
  deliveryManId Int            @map("delivery_man_id")
  summaryId     Int?           @map("summary_id")
  amount        Decimal        @db.Decimal(14, 2)
  method        RecoveryMethod
  receivedAt    DateTime       @map("received_at")
  createdById   Int            @map("created_by")
  createdAt     DateTime       @default(now()) @map("created_at")

  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  customer    Customer      @relation(fields: [customerId], references: [id])
  deliveryMan User          @relation("CreditDeliveryMan", fields: [deliveryManId], references: [id])
  summary     SalesSummary? @relation(fields: [summaryId], references: [id])
  createdBy   User          @relation("CreditCreatedBy", fields: [createdById], references: [id])

  @@map("credit_recoveries")
}

// ======
// WAGES
// ======

model Wage {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  year      Int
  month     Int
  amount    Decimal  @db.Decimal(14, 2)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, year, month], name: "uniq_user_month")
  @@map("wages")
}

// =========
// AUTH / JWT
// =========

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}
